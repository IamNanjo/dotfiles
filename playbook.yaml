- name: Set up dotfiles
  hosts: localhost
  any_errors_fatal: true

  tasks:
    - name: Install packages for Arch
      become: true
      when: ansible_distribution == "Arch"
      community.general.pacman:
        name:
          - base
          - base-devel
          - git
          - curl
          - wget
          - zsh
          - plocate
          - stow
          - neovim
    
    - name: Install packages for Ubuntu
      become: true
      when: ansible_distribution == "Ubuntu"
      ansible.builtin.apt:
        name:
          - build-essential
          # == Mise tool build dependencies ==
          # Ruby
          - zlib1g-dev
          - libffi-dev
          - libyaml-dev
          # Lua
          - libreadline-dev
          # ==================================
          - git
          - curl
          - wget
          - zsh
          - plocate
          - stow
        state: latest

    - name: Check if mise is installed
      register: mise_installed
      ansible.builtin.stat:
        path: "{{ ansible_env.HOME }}/.local/bin/mise"

    - name: Install mise
      when: not mise_installed.stat.exists
      ansible.builtin.shell: curl https://mise.run | sh

    - name: Install mise tools
      loop:
        - usage
        - node
        - bun
        - go
        - rust
        - python
        - ruby
        - perl
        - lua@5.1
      ansible.builtin.shell: $HOME/.local/bin/mise use -g -y {{ item }}

    - name: Install oh-my-zsh
      ansible.builtin.shell: sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

    - name: Install fast-syntax-highlighting for zsh
      ansible.builtin.shell: >
        git clone https://github.com/zdharma-continuum/fast-syntax-highlighting.git
        ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/fast-syntax-highlighting

    - name: Install Neovim
      become: true
      when: ansible_distribution != "Arch"
      ansible.builtin.shell: >
        curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz &&
        sudo rm -rf /opt/nvim &&
        sudo tar -C /opt -xzf nvim-linux64.tar.gz &&

    - name: Add Neovim to path
      when: ansible_distribution != "Arch"
      ansible.builtin.shell: echo 'export PATH="$PATH:/opt/nvim-linux64/bin"' >> $HOME/.env

    - name: Prepare directories for symlinks
      loop:
        - .local/bin
        - .config/gtk-3.0
        - .config/hypr
        - .config/zed
      ansible.builtin.shell: "mkdir -p $HOME/{{ item }}"

    - name: Delete conflicting files
      loop:
        - .bashrc
        - .zshrc
      ansible.builtin.shell: rm $HOME/{{ item }}

    - name: Set up symlinks using GNU Stow
      register: result
      changed_when: 'result.stderr is search("LINK: ")'
      loop:
        - basic
        - hyprland
        - nvim
        - scripts
        - wezterm
        - zed
        - zsh
      ansible.builtin.shell: "stow {{ item }} --target $HOME --verbose=2"

    - name: Use catppuccin theme for zsh fast-syntax-highlighting
      ansible.builtin.shell: fast-theme XDG:catppuccin-mocha
